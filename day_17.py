program = [1,330,331,332,109,3376,1101,1182,0,16,1102,1,1449,24,101,0,0,570,1006,570,36,1001,571,0,0,1001,570,-1,570,1001,24,1,24,1105,1,18,1008,571,0,571,1001,16,1,16,1008,16,1449,570,1006,570,14,21102,1,58,0,1106,0,786,1006,332,62,99,21101,0,333,1,21101,0,73,0,1105,1,579,1101,0,0,572,1101,0,0,573,3,574,101,1,573,573,1007,574,65,570,1005,570,151,107,67,574,570,1005,570,151,1001,574,-64,574,1002,574,-1,574,1001,572,1,572,1007,572,11,570,1006,570,165,101,1182,572,127,1002,574,1,0,3,574,101,1,573,573,1008,574,10,570,1005,570,189,1008,574,44,570,1006,570,158,1105,1,81,21102,1,340,1,1105,1,177,21102,477,1,1,1105,1,177,21102,1,514,1,21101,176,0,0,1105,1,579,99,21102,184,1,0,1105,1,579,4,574,104,10,99,1007,573,22,570,1006,570,165,102,1,572,1182,21102,1,375,1,21102,211,1,0,1105,1,579,21101,1182,11,1,21102,222,1,0,1105,1,979,21101,388,0,1,21102,233,1,0,1106,0,579,21101,1182,22,1,21102,1,244,0,1105,1,979,21101,401,0,1,21101,0,255,0,1105,1,579,21101,1182,33,1,21102,1,266,0,1106,0,979,21102,414,1,1,21102,1,277,0,1105,1,579,3,575,1008,575,89,570,1008,575,121,575,1,575,570,575,3,574,1008,574,10,570,1006,570,291,104,10,21102,1,1182,1,21101,0,313,0,1106,0,622,1005,575,327,1101,0,1,575,21101,0,327,0,1106,0,786,4,438,99,0,1,1,6,77,97,105,110,58,10,33,10,69,120,112,101,99,116,101,100,32,102,117,110,99,116,105,111,110,32,110,97,109,101,32,98,117,116,32,103,111,116,58,32,0,12,70,117,110,99,116,105,111,110,32,65,58,10,12,70,117,110,99,116,105,111,110,32,66,58,10,12,70,117,110,99,116,105,111,110,32,67,58,10,23,67,111,110,116,105,110,117,111,117,115,32,118,105,100,101,111,32,102,101,101,100,63,10,0,37,10,69,120,112,101,99,116,101,100,32,82,44,32,76,44,32,111,114,32,100,105,115,116,97,110,99,101,32,98,117,116,32,103,111,116,58,32,36,10,69,120,112,101,99,116,101,100,32,99,111,109,109,97,32,111,114,32,110,101,119,108,105,110,101,32,98,117,116,32,103,111,116,58,32,43,10,68,101,102,105,110,105,116,105,111,110,115,32,109,97,121,32,98,101,32,97,116,32,109,111,115,116,32,50,48,32,99,104,97,114,97,99,116,101,114,115,33,10,94,62,118,60,0,1,0,-1,-1,0,1,0,0,0,0,0,0,1,20,24,0,109,4,1201,-3,0,586,21002,0,1,-1,22101,1,-3,-3,21102,1,0,-2,2208,-2,-1,570,1005,570,617,2201,-3,-2,609,4,0,21201,-2,1,-2,1106,0,597,109,-4,2105,1,0,109,5,2102,1,-4,630,20102,1,0,-2,22101,1,-4,-4,21102,1,0,-3,2208,-3,-2,570,1005,570,781,2201,-4,-3,653,20101,0,0,-1,1208,-1,-4,570,1005,570,709,1208,-1,-5,570,1005,570,734,1207,-1,0,570,1005,570,759,1206,-1,774,1001,578,562,684,1,0,576,576,1001,578,566,692,1,0,577,577,21101,702,0,0,1105,1,786,21201,-1,-1,-1,1105,1,676,1001,578,1,578,1008,578,4,570,1006,570,724,1001,578,-4,578,21102,1,731,0,1105,1,786,1106,0,774,1001,578,-1,578,1008,578,-1,570,1006,570,749,1001,578,4,578,21102,1,756,0,1105,1,786,1106,0,774,21202,-1,-11,1,22101,1182,1,1,21101,0,774,0,1105,1,622,21201,-3,1,-3,1105,1,640,109,-5,2105,1,0,109,7,1005,575,802,21002,576,1,-6,21002,577,1,-5,1105,1,814,21102,1,0,-1,21101,0,0,-5,21102,1,0,-6,20208,-6,576,-2,208,-5,577,570,22002,570,-2,-2,21202,-5,41,-3,22201,-6,-3,-3,22101,1449,-3,-3,2102,1,-3,843,1005,0,863,21202,-2,42,-4,22101,46,-4,-4,1206,-2,924,21102,1,1,-1,1105,1,924,1205,-2,873,21101,0,35,-4,1105,1,924,1202,-3,1,878,1008,0,1,570,1006,570,916,1001,374,1,374,2101,0,-3,895,1101,0,2,0,2102,1,-3,902,1001,438,0,438,2202,-6,-5,570,1,570,374,570,1,570,438,438,1001,578,558,921,21002,0,1,-4,1006,575,959,204,-4,22101,1,-6,-6,1208,-6,41,570,1006,570,814,104,10,22101,1,-5,-5,1208,-5,47,570,1006,570,810,104,10,1206,-1,974,99,1206,-1,974,1102,1,1,575,21101,0,973,0,1105,1,786,99,109,-7,2105,1,0,109,6,21102,1,0,-4,21101,0,0,-3,203,-2,22101,1,-3,-3,21208,-2,82,-1,1205,-1,1030,21208,-2,76,-1,1205,-1,1037,21207,-2,48,-1,1205,-1,1124,22107,57,-2,-1,1205,-1,1124,21201,-2,-48,-2,1106,0,1041,21101,-4,0,-2,1106,0,1041,21102,-5,1,-2,21201,-4,1,-4,21207,-4,11,-1,1206,-1,1138,2201,-5,-4,1059,2101,0,-2,0,203,-2,22101,1,-3,-3,21207,-2,48,-1,1205,-1,1107,22107,57,-2,-1,1205,-1,1107,21201,-2,-48,-2,2201,-5,-4,1090,20102,10,0,-1,22201,-2,-1,-2,2201,-5,-4,1103,2102,1,-2,0,1105,1,1060,21208,-2,10,-1,1205,-1,1162,21208,-2,44,-1,1206,-1,1131,1105,1,989,21101,439,0,1,1105,1,1150,21101,0,477,1,1105,1,1150,21102,514,1,1,21102,1149,1,0,1105,1,579,99,21102,1157,1,0,1106,0,579,204,-2,104,10,99,21207,-3,22,-1,1206,-1,1138,2102,1,-5,1176,2102,1,-4,0,109,-6,2105,1,0,22,11,30,1,9,1,30,1,9,1,30,1,9,1,30,1,9,1,30,1,9,1,30,1,9,5,26,1,13,1,26,1,13,1,26,1,13,1,10,5,5,7,13,1,10,1,3,1,5,1,19,1,10,1,3,1,5,1,11,13,6,1,3,1,5,1,11,1,7,1,3,12,5,1,11,1,7,1,3,2,5,1,9,1,11,1,7,1,3,2,5,1,7,5,9,1,7,6,5,1,7,1,1,1,1,1,9,1,12,1,5,1,7,1,1,1,1,1,9,1,12,1,5,1,7,1,1,1,1,1,9,1,12,13,1,1,1,1,1,1,9,1,18,1,5,1,1,1,1,1,1,1,9,1,18,11,1,11,24,1,1,1,36,11,30,1,1,1,1,1,26,5,5,1,1,1,1,13,14,1,3,1,5,1,1,1,13,1,14,1,3,1,5,1,1,1,13,1,14,1,3,1,5,1,1,1,13,1,14,13,13,1,18,1,5,1,15,1,18,1,5,1,15,11,8,1,5,1,25,1,8,1,5,1,25,1,8,1,5,1,25,1,8,7,25,1,40,1,40,1,40,1,40,1,40,1,34,7,34,1,40,1,40,1,40,1,10]

class Intcode:
    def __init__(self, program):
        self.i = 0
        self.program = program.copy()
        self.input = None
        self.relative_base = 0
        self.halted = False
        self.waiting_for_input = False

    def read_parameter_value(self, parameter, mode):
        # position mode
        if mode == 0:
            index = parameter
            self.expand_memory_space(index)
            return self.program[index]
        # immediate mode
        elif mode == 1:
            return parameter
        # relative mode
        elif mode == 2:
            index = self.relative_base + parameter
            self.expand_memory_space(index)
            return self.program[index]
        else:
            print('Invalid parameter value')

    def write_parameter_address(self, parameter, mode):
        # position mode
        if mode == 0:
            index = parameter
            self.expand_memory_space(index)
            return index
        # relative mode
        elif mode == 2:
            index = self.relative_base + parameter
            self.expand_memory_space(index)
            return index
        else:
            print('Invalid parameter value')

    def opcode_setting(self):
        opcode_setting_string = str(self.program[self.i])
        return opcode_setting_string.zfill(5)

    def opcode_and_parameter_modes(self, parameters):
        opcode = int(''.join([parameters[3], parameters[4]]))
        parameter1Mode = int(parameters[2])
        parameter2Mode = int(parameters[1])
        parameter3Mode = int(parameters[0])

        return [opcode, parameter1Mode, parameter2Mode, parameter3Mode]

    def expand_memory_space(self, index):
        if index >= self.program.__len__():
            required_padding = index - self.program.__len__() + 1
            self.program += [0] * required_padding

    def assign_to_address(self, index, value):
        self.expand_memory_space(index)
        self.program[index] = value

    def run(self):
        self.waiting_for_input = False
        output = None

        while True:
            opcode_setting = self.opcode_setting()
            opcode, parameter1Mode, parameter2Mode, parameter3Mode = self.opcode_and_parameter_modes(opcode_setting)

            if len(self.program) > (self.i + 1):
                parameter1 = int(self.program[self.i + 1])
            if len(self.program) > (self.i + 3):
                parameter2 = int(self.program[self.i + 2])
                parameter3 = int(self.program[self.i + 3])

            if opcode == 1:  # addition
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                value2 = self.read_parameter_value(parameter2, parameter2Mode)
                destination_address = self.write_parameter_address(parameter3, parameter3Mode)
                self.assign_to_address(destination_address, value1 + value2)
                self.i += 4

            elif opcode == 2:  # multiplication
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                value2 = self.read_parameter_value(parameter2, parameter2Mode)
                destination_address = self.write_parameter_address(parameter3, parameter3Mode)
                self.assign_to_address(destination_address, value1 * value2)
                self.i += 4

            elif opcode == 3:  # takes input and saves to parameter address
                if self.input is None:
                    self.waiting_for_input = True
                    break
                destination_address = self.write_parameter_address(parameter1, parameter1Mode)
                self.assign_to_address(destination_address, self.input)
                self.input = None
                self.i += 2

            elif opcode == 4:  # outputs the value of the parameter, stops program
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                output = value1  # does an output
                self.i += 2
                break

            elif opcode == 5:  # jump if true
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                value2 = self.read_parameter_value(parameter2, parameter2Mode)
                if value1 != 0:
                    self.i = value2
                else:
                    self.i += 3

            elif opcode == 6:  # jump if false
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                value2 = self.read_parameter_value(parameter2, parameter2Mode)
                if value1 == 0:
                    self.i = value2
                else:
                    self.i += 3

            elif opcode == 7:  # less than
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                value2 = self.read_parameter_value(parameter2, parameter2Mode)
                destination_address = self.write_parameter_address(parameter3, parameter3Mode)
                if value1 < value2:
                    self.assign_to_address(destination_address, 1)
                else:
                    self.assign_to_address(destination_address, 0)
                self.i += 4

            elif opcode == 8:  # equal to
                value1 = self.read_parameter_value(parameter1, parameter1Mode)
                value2 = self.read_parameter_value(parameter2, parameter2Mode)
                destination_address = self.write_parameter_address(parameter3, parameter3Mode)
                if value1 == value2:
                    self.assign_to_address(destination_address, 1)
                else:
                    self.assign_to_address(destination_address, 0)
                self.i += 4

            elif opcode == 9:  # relative base adjustment
                self.relative_base += self.read_parameter_value(parameter1, parameter1Mode)
                self.i += 2

            elif opcode == 99:
                print('HALTED')
                self.halted = True
                break

            else:
                print(f'Invalid opcode at {self.i}')
                break

        return output


class RobotCamera:
    SCAFFOLDING = 1
    NON_SCAFFOLDING = 2

    def __init__(self, program):
        self.program = program
        self.intcode = Intcode(self.program)
        self.intcode_outputs = []
        self.locations = {}

    def run(self):
        i = 0
        while True:
            self.intcode_outputs = []
            while True:
                output = self.intcode.run()
                self.intcode_outputs.append(output)
                if self.intcode.halted or self.intcode.waiting_for_input:
                    break
            self.record_locations()
            self.print()

            if self.intcode.halted:
                break

    def operate_robot(self, inputs):
        input_buffer = inputs.copy()
        while True:
            self.intcode_outputs = []
            while True:
                if self.intcode.input is None and self.intcode.waiting_for_input:
                    self.intcode.input = input_buffer[0]
                    del input_buffer[0]
                output = self.intcode.run()
                self.intcode_outputs.append(output)
                if self.intcode.halted:
                    break
            # self.record_locations()
            self.print()

            if self.intcode.halted:
                break

    def calculate_intersections(self):
        intersections = []
        for location_key in self.locations.keys():
            x, y = map(int, location_key.split(','))
            adjacent_locations = [f'{x+1},{y}', f'{x-1},{y}', f'{x},{y+1}', f'{x},{y-1}']
            if all([location in self.locations.keys() and self.locations[location] == self.SCAFFOLDING for location in adjacent_locations]):
                if self.locations[location_key] != self.SCAFFOLDING:
                    continue
                intersections.append(location_key)

        sum_of_alignment_parameters = 0
        for intersection in intersections:
            x, y = map(int, intersection.split(','))
            sum_of_alignment_parameters += (x * y)

        return sum_of_alignment_parameters

    def record_locations(self):
        scaffoling_characters = ['#']
        rows = ''.join([chr(code) for code in self.intcode_outputs if code is not None]).split('\n')
        rows = [row for row in rows if row.__ne__('')]
        self.locations = {}
        for j, row in enumerate(rows):
            row_list = list(row)
            for i, character in enumerate(row_list):
                if character in scaffoling_characters:
                    self.locations[f'{i},{j}'] = self.SCAFFOLDING
                else:
                    self.locations[f'{i},{j}'] = self.NON_SCAFFOLDING

    def print(self):
        print_buffer = ''.join([chr(code) for code in self.intcode_outputs if code is not None])
        print(print_buffer)


# part 1
# camera = RobotCamera(program)
# camera.run()
# print(camera.calculate_intersections())


# part 2
movement_routing = ','.join(['A', 'B', 'A', 'B', 'A', 'C', 'B', 'C', 'A', 'C']) + '\n'
A = ','.join(['L', '9', '1', 'L', '9', '3', 'R', '6']) + '\n'
B = ','.join(['R', '9', '1', 'L', '4', 'L', '4', 'L', '9', '3']) + '\n'
C = ','.join(['L', '9', '1', 'R', '9', '1', 'R', '6', 'L', '4']) + '\n'
camera_output = ','.join(['n']) + '\n'
commands = movement_routing + A + B + C + camera_output
commands = list(map(ord, commands)) # to ASCII code

program[0] = 2 # wake up robot
camera = RobotCamera(program)
camera.operate_robot(commands)
print(camera.intcode_outputs[-2])
# L, 10, L, 12, R, 6, R, 10, L, 4, L, 4, L, 12, L, 10, L, 12, R, 6, R, 10, L, 4, L, 4, L, 12, L, 10,
# L, 12, R, 6, <><> L, 10, R, 10, R, 6, L, 4, <><> R, 10, L, 4, L, 4, L, 12, <><> L, 10, R, 10, R, 6, L, 4 <><>
# L, 10, L, 12, R, 6,#<continue here>  L, 10, R, 10, R, 6, L, 4

# A: L, 10, L, 12, R, 6
# B: R, 10, L, 4, L, 4, L, 9, 3
# C: L, 10, R, 10, R, 6, L, 4
# A, B, A, B, A, C, B, C, A, C